// Grinder v0.1.0
// Copyright 2014 Justin Martin, MIT License
// http://github.com/justspamjustin/grinder
(function(){window.Grinder={},window.controller=function(e){var t,n,r;t="function ",n=null;try{n=e.toString().match(new RegExp(""+t+".*Controller"))[0].replace(t,"")}catch(i){throw r=i,new Error("Controller should be named ending in Controller")}return Grinder.controllers||(Grinder.controllers={}),Grinder.controllers[n]=e},window.view=function(e){var t,n,r;t="function ",r=null;try{r=e.toString().match(new RegExp(""+t+".*View"))[0].replace(t,"")}catch(i){throw n=i,new Error("View should be named ending in View")}return Grinder.views||(Grinder.views={}),Grinder.views[r]=e}}).call(this),function(){Grinder.Application=function(){function e(){}return e.prototype.start=function(){return _.mixin(_.string.exports()),this.setupRoutes(),this.setupEmbeddedControllers($("body")),Backbone.history.start({pushState:!0})},e.prototype.setupRoutes=function(){var e,t,n,r,i,s,o,u=this;this.appRoutes=this.getRoutes(),i={},r=[],o=function(e,t){return i[s]=function(){var n;return n=$("#main"),u.setupNewController(e,n,t)}};for(s in this.appRoutes)t=this.appRoutes[s],n=this.initializeControllerFromAction(t),r.push(n),o(n,t);return e=Backbone.Router.extend({routes:i}),this.appRouter=new e,this.setupRouteEvents(r)},e.prototype.setupRouteEvents=function(e){return this.appRouter.on("route",function(t,n){var r,i,s,o,u;i=window.location.href.replace(/^http(s)?:\/\/[^\/]+\//,""),u=[];for(s=0,o=e.length;s<o;s++)r=e[s],u.push(typeof r.onRoute=="function"?r.onRoute(i,n):void 0);return u})},e.prototype.setupNewController=function(e,t,n){var r,i,s,o,u;return u=n.split("#"),i=u[0],r=u[1],e[r](),o=Grinder.views[""+_(i).titleize()+"View"].t,s=new Ractive({el:t,template:o,data:e}),s.on("set",function(){return this.initializeEvents(t,o,e,s),this.initializeAnchorEvents()}),this.initializeEvents(t,o,e,s),this.initializeAnchorEvents()},e.prototype.initializeControllerFromAction=function(e){var t;return t=e.split("#")[0],t=""+_(t).titleize()+"Controller",new Grinder.controllers[t]},e.prototype.routes=function(e){return this.getRoutes=e,this},e.prototype.getRoutes=function(){throw new Error("You must provide a routes function that returns your routes.")},e.prototype.initializeEvents=function(e,t,n,r){var i,s,o,u,a,f,l,c=this;u=t.match(/event-(\w*)=['"]#\w+['"]/gm)||[],l=[];for(a=0,f=u.length;a<f;a++)o=u[a],s=o.replace(/event\-|=.*/g,""),i=o.replace(/event-(.*)=.#/,""),i=i.substring(0,i.length-1),l.push(function(n,r,i,s,o){return $("["+n+"]").off(i),$("["+n+"]").on(i,function(n){var i,u;r[s](n);for(i in r)u=r[i],o.set(i,u);return c.initializeEvents(e,t,r,o)})}(o,n,s,i,r));return l},e.prototype.setupEmbeddedControllers=function(e){var t,n=this;return t=e.find("[controller]"),t.each(function(e,t){var r,i;return r=$(t).attr("controller"),i=n.initializeControllerFromAction(r),n.setupNewController(i,$(t),r),n.setupRouteEvents([i])})},e.prototype.initializeAnchorEvents=function(){return $("a").each(function(){return $(this).off("click.navigate"),$(this).on("click.navigate",function(e){var t;t=$(this).attr("href");if(!/^(http(s)?:)?\/\/.*$/.test(t))return e.preventDefault(),Backbone.history.navigate(t,{trigger:!0})})})},e}()}.call(this)